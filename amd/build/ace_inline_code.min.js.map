{"version":3,"file":"ace_inline_code.min.js","sources":["../src/ace_inline_code.js"],"sourcesContent":["/**\n * This file is part of Moodle - http:moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http:www.gnu.org/licenses/>.\n */\n\n/**\n * JavaScript for implementing both the ace_highlight_code and ace_interactive_code\n * functionality of the ace_line filter (q.v.)\n *\n * @module filter_ace_inline/highlight_code\n * @copyright  Richard Lobb, 2021, The University of Canterbury\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/*jshint esversion: 8 */\n\ndefine([], function() {\n    const RESULT_SUCCESS = 15;  // Code for a correct Jobe run.\n    const ACE_DARK_THEME = 'ace/theme/tomorrow_night';\n    const ACE_LIGHT_THEME = 'ace/theme/textmate';\n    const MIN_WINDOW_LINES = 1;\n    const MAX_WINDOW_LINES = 50;\n    const MAX_OUTPUT_LENGTH = 30000;\n\n    let uploadFiles = {};\n    /**\n     * Escape text special HTML characters.\n     * @param {string} text\n     * @returns {string} text with various special chars replaced with equivalent\n     * html entities. Newlines are replaced with <br>.\n     */\n    function escapeHtml(text) {\n      const map = {\n        '&': '&amp;',\n        '<': '&lt;',\n        '>': '&gt;',\n        '\"': '&quot;',\n        \"'\": '&#039;'\n      };\n\n      return text.replace(/[&<>\"']/g, function(m) { return map[m]; });\n    }\n\n    /**\n     * Extract from the given DOM pre element its various attributes.\n     * @param {DOMElement} pre The <pre> element from the DOM.\n     * @param {object} defaultParams An object with the default UI parameters.\n     * @returns {object} The original defaultParams object with any attributes\n     * that exist with in the <pre> element replaced by the pre element\n     * attributes. As special cases if there is a start-line-number parameter\n     * with the value 'none', start-line-number is set to null.\n     */\n    function getUiParameters(pre, defaultParams) {\n        let uiParameters = {};\n        let modifiedLang = false;\n\n        for (const attrName in defaultParams) {\n            if (defaultParams.hasOwnProperty(attrName)) { // Redundant but shuts up jshint\n                let value = '', dataName = '';\n                let attr = pre.attributes.getNamedItem(attrName);\n                if (attr) {\n                    dataName = attrName;\n                } else {  // Try data- as a prefix if 'raw' access fails.\n                    dataName = 'data-' + attrName;\n                    attr = pre.attributes.getNamedItem(dataName);\n                }\n                if (attr) {\n                    value = attr.value;\n                    switch (attrName) {\n                        case 'start-line-number':\n                            value = value.toLowerCase() === 'none' ? null : parseInt(value);\n                            break;\n                        case 'min-lines':\n                        case 'max-lines':\n                            value = parseInt(value);\n                            break;\n                        case 'hidden':\n                            value = true; // If the 'hidden' attribute exists, it's True!\n                            break;\n                        case 'lang':\n                            modifiedLang = true; // Keeps track of modifications, so no overrides.\n                            break;\n                        default:\n                            break;\n                    }\n                } else {\n                    value = defaultParams[attrName];\n                }\n                uiParameters[attrName] = value;\n            }\n        }\n        // Takes the data-lang from the class if edited using Prism TinyMCE editor filter.\n        const splitClass = uiParameters['class'].split(\" \");\n        // Left open so can deal with more attributes if desired.\n        splitClass.forEach((attribute) => {\n            if (attribute.startsWith('language') && modifiedLang === false) {\n                uiParameters['lang'] = attribute.replace('language-', '');\n            }\n        });\n        return uiParameters;\n    }\n\n    /**\n     * Get the specified language string and return a promise with the respective\n     * language string output.\n     * @param {string} langStringName The language string name.\n     * should be plugged.\n     * @returns {string} Promise with the language string output.\n     */\n    async function getLangString(langStringName) {\n        return new Promise((resolve) => {\n            require(['core/str'], function(str) {\n                resolve(str.get_string(langStringName, 'filter_ace_inline'));\n            });\n        });\n    }\n\n\n    /**\n     * Analyse the response for errors. There are two sorts of error: sandbox failures,\n     * for which the field response.error is non-zero meaning the run didn't take\n     * place at all and failures in the run\n     * itself, such as compile errors, timeouts, runtime errors etc. The\n     * various codes are documented in the CodeRunner file sandbox.php.\n     * Some error returns, notably compilation error and runtime error, are not\n     * treated as errors here, since the stdout + stderr should reveal what\n     * happened anyway. More obscure errors are lumped together as 'Unknown\n     * runtime error'.\n     * @param {object} response The response from the web-service sandbox request.\n     * @returns string The language string to use for an error message or '' if\n     * no error message.\n     */\n    function diagnose(response) {\n        // Table of error conditions.\n        // Each row is response.error, response.result, langstring\n        // response.result is ignored if response.error is non-zero.\n        // Any condition not in the table is deemed an \"Unknown runtime error\".\n        const ERROR_RESPONSES = [\n            [1, 0, 'error_access_denied'], // Sandbox AUTH_ERROR\n            [2, 0, 'error_unknown_language'], // Sandbox WRONG_LANG_ID\n            [3, 0, 'error_access_denied'], // Sandbox ACCESS_DENIED\n            [4, 0, 'error_submission_limit_reached'], // Sandbox SUBMISSION_LIMIT_EXCEEDED\n            [5, 0, 'error_sandbox_server_overload'], // Sandbox SERVER_OVERLOAD\n            [0, 11, ''], // RESULT_COMPILATION_ERROR\n            [0, 12, ''], // RESULT_RUNTIME_ERROR\n            [0, 13, 'error_timeout'], // RESULT TIME_LIMIT\n            [0, RESULT_SUCCESS, ''], // RESULT_SUCCESS\n            [0, 17, 'error_memory_limit'], // RESULT_MEMORY_LIMIT\n            [0, 21, 'error_sandbox_server_overload'], // RESULT_SERVER_OVERLOAD\n            [0, 30, 'error_excessive_output']  // RESULT OUTPUT_LIMIT\n        ];\n        for (const row of ERROR_RESPONSES) {\n            if (row[0] == response.error && (response.error != 0 || response.result == row[1])) {\n                return row[2];\n            }\n        }\n        return 'error_unknown_runtime';\n    }\n\n    /**\n     * Concatenates the cmpinfo, stdout and stderr fields of the sandbox\n     * response, truncating both stdout and stderr to a given maximum length\n     * if necessary (in which case '... (truncated)' is appended.\n     * @param {object} response Sandbox response object\n     * @param {int} maxLen The maximum length of the trimmed stringlen.\n     */\n    function combinedOutput(response, maxLen) {\n        const limit = s => s.length <= maxLen ? s : s.substr(0, maxLen) + '... (truncated)';\n        return response.cmpinfo + limit(response.output) + limit(response.stderr);\n    }\n\n    /**\n     * Gets the uiParameter of 'stdin-taid' which should be the id of an element.\n     * @param {object} uiParameters The various parameters (mostly attributes of the pre element)\n     * @returns {string} The specified standard input or an empty string if no\n     * stdin specified or null if not valid.\n     */\n    function getStdin(uiParameters) {\n        const taid = uiParameters['stdin-taid'];\n        const stdin = uiParameters.stdin;\n        if (taid) {\n            const box = document.querySelector('#' + taid);\n            // Handles invalid textarea names.\n            return box === null ? null : box.value;\n        } else if (stdin) {\n            return stdin;\n        } else {\n            return '';\n        }\n    }\n\n    /**\n     * Gets the uiParameter 'file-taids' and parses it if it is JSON. Promises an\n     * arbitrary non-JSON object for error handling in the run_in_sandbox.php, else\n     * promises a JSON object of appropriate mappings\n     *\n     * @param {object} uiParameters The various parameters (mostly attributes of the pre element)\n     * @returns {string} An JSON-encoding of an object that defines one or more\n     * filename:filecontents mappings.\n     */\n    async function getFiles(uiParameters) {\n        let taids = uiParameters['file-taids'];\n        let map = {};\n\n        if (Object.keys(taids).length !== 0) {\n            // Catches JSON parse errors for file names.\n            try {\n                taids = JSON.parse(taids);\n            } catch (SyntaxError) {\n                return Promise.resolve('error');\n            }\n            for (const filename in taids) {\n                if (taids.hasOwnProperty(filename)) {\n                    const id = taids[filename];\n                    const file = document.querySelector('#' + id);\n                    if (file === null) {\n                        return Promise.resolve('bad_id');\n                    } else {\n                        map[filename] = file.value;\n                    }\n                }\n            }\n        }\n\n        // Merge in any explicitly uploaded files.\n        for (const name in uploadFiles) {\n            if (uploadFiles.hasOwnProperty(name)) {\n                map[name] = uploadFiles[name]; // Copy contents across.\n            }\n        }\n        return Promise.resolve(JSON.stringify(map));\n    }\n\n    /**\n     * Handle a click on the Try it! button; pre-checks the taids for valid ids.\n     * @param {html_element} outputDisplayArea The HTML <p> element in which to display output.\n     * @param {string} code The code to be run.\n     * @param {int} uiParameters The various parameters (mostly attributes of the pre element).\n     * Keys are button-name, lang, stdin, files, params, prefix, suffix, codemapper, html-output.\n     * @returns {string} code of the code to run, else null but executes errors if needed.\n     */\n    async function handleButtonClick(outputDisplayArea, code, uiParameters) {\n        cleanOutput(outputDisplayArea);\n        outputDisplayArea.style.display = '';\n\n        const mapFunc = uiParameters['code-mapper'];\n        if (mapFunc) {\n            code = window[mapFunc](code);\n        }\n        code = uiParameters.prefix + code + uiParameters.suffix;\n        // Get the parameters by parsing.\n        const stdin = getStdin(uiParameters);\n        const files = await getFiles(uiParameters);\n        // If html/markup is the chosen language; change uiParameters and wrap in Python.\n        if ((uiParameters['lang'] === 'markup') || (uiParameters['lang'] === 'html')) {\n            outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-html');\n            // Save for returning to old language.\n            uiParameters['prev-lang'] = uiParameters['lang'];\n            uiParameters['html-output'] = true;\n            uiParameters['lang'] = 'python3';\n            code = \"print('''\" + code + \"''')\";\n            return code;\n        }\n        // If textareas are found, pass in the output areas into the UI parameters.\n        if (stdin !== null && files !== 'bad_id' ) {\n            uiParameters['stdin-parse'] = stdin;\n            uiParameters['file-parse'] = files;\n            return code;\n        } else {\n            // Make it display an error.\n            outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-user');\n            let text = await getLangString('error_user_params');\n            text = '*** ' + text + ' ***\\n' + await getLangString('error_element_unknown');\n            outputDisplayArea.children.item(0).innerHTML = escapeHtml(text);\n            return null;\n        }\n    }\n\n    /**\n     * Executes the code through CodeRunner run_in_sandbox.\n     * @param {object} ajax The core Moodle ajax module.\n     * @param {html_element} outputDisplayArea The HTML <p> element in which to display output.\n     * @param {string} code The code to be run.\n     * @param {int} uiParameters The various parameters (mostly attributes of the pre element).\n     * Keys are button-name, lang, stdin, files, params, prefix, suffix, codemapper, html-output.\n     */\n    async function executeCode(ajax, outputDisplayArea, code, uiParameters) {\n        const htmlOutput = uiParameters['html-output'] !== null;\n        const maxLen = uiParameters['max-output-length'];\n        let text = '';\n        let langString = '';\n        ajax.call([{\n            methodname: 'qtype_coderunner_run_in_sandbox',\n            args: {\n                contextid: M.cfg.contextid,\n                sourcecode: code,\n                language: uiParameters.lang,\n                stdin: uiParameters['stdin-parse'],\n                files: uiParameters['file-parse'],\n                params: uiParameters.params\n            },\n            done: function(responseJson) {\n                cleanOutput(outputDisplayArea);\n                const response = JSON.parse(responseJson);\n                const error = diagnose(response);\n                if (error === '') {\n                    // If no errors or compilation error or runtime error.\n                    if (!htmlOutput || response.result !== RESULT_SUCCESS) {\n                        // Either it's not HTML output or it is but we have compilation or runtime errors.\n                        text += combinedOutput(response, maxLen);\n                        // If there is an execution error, change the output class.\n                        if (response.result !== RESULT_SUCCESS) {\n                            outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-error');\n                        }\n                    } else { // Valid HTML output - just plug in the raw html to the DOM.\n                        outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-html');\n                        const html = createComponent('div', ['filter-ace-inline-html'], {});\n                        html.innerHTML = response.output;\n                        outputDisplayArea.after(html);\n                    }\n                } else {\n                    // If an error occurs, display the language string in the\n                    // outputDisplayArea plus additional info, for non-sandbox errors.\n                    outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-error');\n                    let extra = response.error == 0 ? combinedOutput(response, maxLen) : '';\n                    if (error === 'error_unknown_runtime') {\n                        extra += response.error ? '(Sandbox error code ' + response.error + ')' :\n                            '(Run result: ' + response.result + ')';\n                    }\n                    langString += error;\n                    text += extra;\n                }\n               displayTextOutput(text, langString, outputDisplayArea);\n            },\n            fail: function(error) {\n                cleanOutput(outputDisplayArea);\n                // Change the outputDisplayArea to something more ominious...\n                outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-user');\n                langString += 'error_user_params';\n                text += error.message;\n                displayTextOutput(text, langString, outputDisplayArea);\n            },\n        }]);\n    }\n\n    /**\n     * Displays the text in the specified outputdisplay area.\n     * @param {string} text Test to be displayed\n     * @param {string} langString LangString for error-handling.\n     * @param {html_element} outputDisplayArea The HTML <p> element in which to display output.\n     */\n    async function displayTextOutput(text, langString, outputDisplayArea) {\n        if (langString !== '') {\n            text = \"*** \" + await getLangString(langString) + \" ***\\n\" + text;\n        }\n        outputDisplayArea.children.item(0).innerHTML = escapeHtml(text);\n    }\n\n    /**\n     * Cleans the outputDisplayArea and resets to normal, removing any next nodes found.\n     * html objects.\n     * @param {type} outputDisplayArea Resets the output box.\n     */\n    function cleanOutput(outputDisplayArea) {\n        outputDisplayArea.children.item(0).innerHTML = '';\n        const potentialHtml = outputDisplayArea.nextElementSibling;\n        if (potentialHtml !== null) {\n            if (potentialHtml.class === 'filter-ace-inline-html') {\n                 outputDisplayArea.nextElementSibling.remove();\n            }\n        }\n        outputDisplayArea.setAttribute('class', 'filter-ace-inline-output-display');\n    }\n\n    /**\n     * Add a UI div containing a Try it! button and a paragraph to display the\n     * results of a button click (hidden until button clicked).\n     * If uiParameters['html-output'] is non-null,\n     * the output paragraph is used only for error output, and the output of the run\n     * is inserted directly into the DOM after the (usually hidden) paragraph.\n     * @param {html_element} insertionPoint The HTML element after which the div should be inserted.\n     * @param {function} getCode A function that retrieves the code to be run.\n     * @param {int} uiParameters The various parameters (mostly attributes of the pre element).\n     * Keys are button-name, lang, stdin, files, params, prefix, suffix, html-output.\n     */\n    async function addUi(insertionPoint, getCode, uiParameters) {\n        // Create the button-node for execution.\n        const button = createComponent('button', ['btn', 'btn-secondary', 'btn-ace-inline-execution'], {'type' :\n                'button'});\n        button.innerHTML = uiParameters['button-name'];\n        // Create the div-node to contain pre-node.\n        const buttonDiv = document.createElement(\"div\");\n        const outputDisplayArea = createComponent('div', ['filter-ace-inline-output-display'], {});\n        // Create a pre-node to contain text.\n        const outputTextArea = createComponent('pre', ['filter-ace-inline-output-text'], {});\n        buttonDiv.append(button);\n        insertionPoint.after(buttonDiv);\n        buttonDiv.after(outputDisplayArea);\n        outputDisplayArea.append(outputTextArea);\n        outputDisplayArea.style.display = 'none';\n        M.util.js_pending('core/ajax');\n        require(['core/ajax'], function(ajax) {\n            button.addEventListener('click', async function() {\n                const code = await handleButtonClick(outputDisplayArea, getCode(), uiParameters);\n                // UI parameters get checked first; and if no error, then returns code.\n                if (code !== null) { // If there was an error.\n                    executeCode(ajax, outputDisplayArea, code, uiParameters);\n                    // Return to old language.\n                    uiParameters['lang'] = uiParameters['prev-lang'] ? uiParameters['prev-lang'] : uiParameters['lang'];\n                }\n            });\n        });\n        M.util.js_complete('core/ajax');\n    }\n\n    /**\n     * Creates elements en masse by taking an elementName and adding classes\n     * and attributes to it.\n     *\n     * @param {type} elementName\n     * @param {type} classList\n     * @param {type} attributeArray\n     * @returns {Element}\n     */\n    function createComponent(elementName, classList, attributeArray) {\n        const element = document.createElement(elementName);\n        classList.forEach(htmlClass => element.classList.add(htmlClass));\n        for (const attribute in attributeArray) {\n            element.setAttribute(attribute, attributeArray[attribute]);\n        }\n        return element;\n    }\n\n\n    /**\n     * Replace any PRE elements of class ace-highlight-code with a\n     * readonly Ace editor window.\n     * @param {DOMElement} root The root of the tree in which highlighting should\n     * be applied.\n     * @param {string} config The plugin configuration settings.\n     */\n    function applyAceHighlighting(root, config) {\n        const defaultParams = {\n            'class': 'ace_highlight_code',\n            'lang': 'python3',\n            'ace-lang': '',\n            'font-size': '11pt',\n            'start-line-number': null,\n            'min-lines': MIN_WINDOW_LINES,\n            'max-lines': MAX_WINDOW_LINES,\n            'readonly': true,\n            'dark-theme-mode': config.dark_theme_mode  // 0, 1, 2 for never, sometimes, always\n        };\n        applyAceAndBuildUi(root, false, defaultParams);\n    }\n\n    /**\n     * Replace any PRE elements of class ace-interactive-code with an\n     * Ace editor window and a Try it! button that allows the code to be run.\n     * @param {DOMElement} root The root of the tree in which the actions should\n     * be applied.\n     * @param {string} config The plugin configuration settings.\n     */\n    function applyAceInteractive(root, config) {\n        const defaultParams = {\n            'class': 'ace_interactive_code',\n            'lang': 'python3',\n            'ace-lang': '',\n            'font-size': '11pt',\n            'hidden': false,\n            'start-line-number': 1,\n            'button-name': config.button_label,\n            'readonly': null,\n            'stdin': '',\n            'stdin-taid': '',\n            'file-taids': {},\n            'file-upload-id': null,\n            'prefix': '',\n            'suffix': '',\n            'params': '{\"cputime\": 5}',\n            'code-mapper': null,\n            'html-output': null,\n            'min-lines': MIN_WINDOW_LINES,\n            'max-lines': MAX_WINDOW_LINES,\n            'max-output-length': MAX_OUTPUT_LENGTH,\n            'dark-theme-mode': config.dark_theme_mode  // 0, 1, 2 for never, sometimes, always\n        };\n        applyAceAndBuildUi(root, true, defaultParams);\n    }\n\n    /**\n     * Return the length of the given line when rendered by the given Ace editor.\n     * @param {Ace-renderer} renderer The Ace renderer.\n     * @param {String} line The line whose length is being checked.\n     * @return {int} The length of the rendered line in pixels.\n     */\n    function lineLength(renderer, line) {\n      const chars = renderer.session.$getStringScreenWidth(line)[0];\n      const width = Math.max(chars, 2) * renderer.characterWidth + // text size\n        2 * renderer.$padding + // padding\n        2  + // little extra for the cursor\n        0; // add border width if needed\n\n      return width;\n    }\n\n    /**\n     * Return the longest of an array of strings.\n     * @param {array} lines An array of lines\n     * @return {String} The longest of the lines\n     */\n    function longest(lines) {\n        let longest = '';\n        for (const line of lines) {\n            if (line.length > longest.length) {\n                longest = line;\n            }\n        }\n        return longest;\n    }\n\n    /**\n     * Set up an onchange handler for file uploads. When the user selects\n     * a file, a FileReader is created to read the contents. While the read\n     * is in progress, a data-busy attribute is set. When the read is complete\n     * a data-file-contents object is defined to map name to contents.\n     * @param {HTMLelement} uploadElementId The input element of type file.\n     */\n    async function setupFileHandler(uploadElementId) {\n\n        /**\n         * Read a single file.\n         * @param {file} file A file from an 'input type=file' element filelist.\n         * @returns {Promise} A promise wrapping the given file's contents.\n         */\n        function readOneFile(file){\n            return new Promise((resolve, reject) => {\n              let rdr = new FileReader();\n              rdr.onload = () => {\n                resolve(rdr.result);\n              };\n              rdr.onerror = reject;\n              rdr.readAsText(file);\n            });\n        }\n\n        const element = document.querySelector('#' + uploadElementId);\n        element.setAttribute('multiple', '1');  // Workaround for the fact Moodle strips this.\n        element.addEventListener('change', async () => {\n            uploadFiles = {};\n            const files = element.files;\n            for (const file of files) {\n                uploadFiles[file.name] = await readOneFile(file);\n            }\n        });\n    }\n\n\n    /**\n     *\n     * @param {html element} pre The pre element that the Ace editor is replacing.\n     * @param {object} uiParameters The UI parameters from the Pre element + defaults.\n     * @param {bool} isInteractive True if the code is interactive.\n     */\n    async function setUpAce(pre, uiParameters, isInteractive) {\n        const aceModeMap = {  // Ace modes for various languages (default: use language name).\n            'c': 'c_cpp',\n            'cpp': 'c_cpp',\n            'js': 'javascript',\n            'nodejs': 'javascript',\n            'c#': 'cs',\n            'octave': 'matlab',\n            'c++': 'c_cpp',\n            'python2': 'python',\n            'python3': 'python',\n            'markup': 'html'\n        };\n        const darkMode = uiParameters['dark-theme-mode']; // 0, 1, 2 for never, sometimes, always\n        let theme = null;\n\n        // Use light or dark theme according to user's prefers-color-scheme.\n        // Default to light.\n        if (darkMode == 2 || (darkMode == 1 && window.matchMedia &&\n                window.matchMedia(\"(prefers-color-scheme: dark)\").matches)) {\n            theme = ACE_DARK_THEME;\n        } else {\n            theme = ACE_LIGHT_THEME;\n        }\n        // Handle the one case of python3 in JOBE.\n        uiParameters.lang = uiParameters.lang === 'python' ? 'python3' : uiParameters.lang;\n        const showLineNumbers = uiParameters['start-line-number'] ? true : false;\n        let aceLang = uiParameters['ace-lang'] ? uiParameters['ace-lang'] : uiParameters.lang;\n        aceLang = aceLang.toLowerCase();\n        if (aceLang in aceModeMap) {\n            aceLang = aceModeMap[aceLang];\n        }\n        const mode = 'ace/mode/' + aceLang;\n        const text = pre.textContent;\n        const lines = text.split(\"\\n\");\n        const numLines = lines.length;\n        const longestLine = longest(lines);\n\n        const editNode = document.createElement('div'); // Ace editor manages this\n        const width = pre.scrollWidth;  // Our first guess at a minimum width.\n        editNode.style.margin = \"6px 0px 6px 0px\";\n        editNode.style.lineHeight = \"1.3\";\n        editNode.style.minWidth = width + \"px\";\n        pre.after(editNode);    // Insert the edit node\n\n        let aceConfig = {\n            newLineMode: \"unix\",\n            mode: mode,\n            minLines: Math.max(numLines, uiParameters['min-lines']),\n            maxLines: uiParameters['max-lines'],\n            fontSize: uiParameters['font-size'],\n            showLineNumbers: showLineNumbers,\n            firstLineNumber: uiParameters['start-line-number'],\n            showGutter: showLineNumbers,\n            showPrintMargin: false,\n            autoScrollEditorIntoView: true,\n            highlightActiveLine: showLineNumbers\n        };\n\n        const editor = window.ace.edit(editNode, aceConfig);\n        const session = editor.getSession();\n        const aceWidestLine = lineLength(editor.renderer, longestLine);\n        if (aceWidestLine > width) {\n            editNode.style.minWidth = Math.ceil(aceWidestLine) + \"px\";\n        }\n        session.setValue(text);\n        editor.setTheme(theme);\n        if (uiParameters.readonly !== null) {\n            editor.setReadOnly(true);\n        }\n\n        // Add a button and text area for output if ace-interactive-code.\n        if (isInteractive) {\n            const getCode = () => editor.getSession().getValue();\n            addUi(editNode, getCode, uiParameters);\n        } else {\n            editor.renderer.$cursorLayer.element.style.display = \"none\"; // Hide cursor.\n        }\n    }\n\n    /**\n     * Replace the given PRE element with an element managed by the Ace editor,\n     * unless 'hidden' is true, in which case we just hide the PRE.\n     * @param {HTMLelement} pre The PRE element to be be replaced by an Ace editor.\n     * @param {bool} isInteractive True for ace-interactive otherwise false.\n     * @param {type} uiParameters the User Interface parameters for the element.\n     */\n    async function applyToPre(pre, isInteractive, uiParameters) {\n        if (uiParameters['file-upload-id']) {\n            setupFileHandler(uiParameters['file-upload-id']);\n        }\n\n        if (!uiParameters.hidden) {\n            setUpAce(pre, uiParameters, isInteractive);\n        } else if (isInteractive) { // Code is hidden but there's still a button to run it.\n            const getCode = () => pre.text();\n            addUi(pre, getCode, uiParameters);\n        }\n\n        pre.style.display = 'none';  // NB this sets display = 'none', checked above.\n    }\n\n    /**\n     * Replace all <pre> and <code> elements in the document rooted at root that have\n     * the given className or ace-inline attribute, with an Ace editor windows that display the\n     * code in whatever language has been set.\n     * @param {object} root The root of the HTML document to modify.\n     * @param {bool} isInteractive True for ace-interactive otherwise false.\n     * @param {object} defaultParams An object defining the allowed pre attributes\n     * that control the state of the Ace editor and the (optional) UI.\n     */\n    async function applyAceAndBuildUi(root, isInteractive, defaultParams) {\n        const className = isInteractive ? 'ace-interactive-code' : 'ace-highlight-code';\n        const alternativeName = isInteractive ? 'data-ace-interactive-code' : 'data-ace-highlight-code';\n        const preElements = root.getElementsByTagName('pre');\n        for (const pre of preElements) {\n            if (pre.style.display !== 'none') {\n                if (pre.classList.contains(className) || pre.hasAttribute(alternativeName)) {\n                    applyToPre(pre, isInteractive, getUiParameters(pre, defaultParams));\n                }\n            }\n        }\n        // For Markdown compatibility.\n        const codeElements = root.getElementsByTagName('code');\n        for (const code of codeElements) {\n            if (code.parentNode !== null && code.style.display !== 'none' &&\n                    (code.hasAttribute(alternativeName) || code.classList.contains(className))) {\n                applyToPre(code.parentNode, isInteractive, getUiParameters(code, defaultParams));\n            }\n        }\n    }\n\n    return {\n        initAceInteractive: async function(config) {\n            if (!window.ace_inline_code_interactive_done) { // Do it once only.\n                window.ace_inline_code_interactive_done = true;\n                while (!window.ace) {\n                    await new Promise(resolve => setTimeout(resolve, 1000));\n                }\n                applyAceInteractive(document, config);\n                // Add a hook for use by dynamically generated content.\n                window.applyAceInteractive = function () {\n                    applyAceInteractive(document, config);\n                };\n            }\n        },\n        initAceHighlighting: async function(config) {\n            if (!window.ace_inline_code_highlighting_done) { // Do it once only.\n                window.ace_inline_code_highlighting_done = true;\n                while (!window.ace) {\n                    await new Promise(resolve => setTimeout(resolve, 1000));\n                }\n                applyAceHighlighting(document, config);\n                // Add a hook for use by dynamically generated content.\n                window.applyAceHighlighting = function () {\n                    applyAceHighlighting(document, config);\n                };\n            }\n        }\n    };\n});"],"names":["define","uploadFiles","escapeHtml","text","map","replace","m","getUiParameters","pre","defaultParams","uiParameters","modifiedLang","attrName","hasOwnProperty","value","dataName","attr","attributes","getNamedItem","toLowerCase","parseInt","split","forEach","attribute","startsWith","getLangString","langStringName","Promise","resolve","require","str","get_string","combinedOutput","response","maxLen","limit","s","length","substr","cmpinfo","output","stderr","handleButtonClick","outputDisplayArea","code","cleanOutput","style","display","mapFunc","window","prefix","suffix","stdin","taid","box","document","querySelector","getStdin","files","taids","Object","keys","JSON","parse","SyntaxError","filename","id","file","name","stringify","getFiles","setAttribute","children","item","innerHTML","displayTextOutput","langString","potentialHtml","nextElementSibling","class","remove","addUi","insertionPoint","getCode","button","createComponent","buttonDiv","createElement","outputTextArea","append","after","M","util","js_pending","ajax","addEventListener","async","htmlOutput","call","methodname","args","contextid","cfg","sourcecode","language","lang","params","done","responseJson","error","ERROR_RESPONSES","row","result","diagnose","html","extra","fail","message","executeCode","js_complete","elementName","classList","attributeArray","element","htmlClass","add","applyAceHighlighting","root","config","applyAceAndBuildUi","dark_theme_mode","applyAceInteractive","button_label","setUpAce","isInteractive","aceModeMap","darkMode","theme","matchMedia","matches","showLineNumbers","aceLang","mode","textContent","lines","numLines","longestLine","longest","line","editNode","width","scrollWidth","margin","lineHeight","minWidth","aceConfig","newLineMode","minLines","Math","max","maxLines","fontSize","firstLineNumber","showGutter","showPrintMargin","autoScrollEditorIntoView","highlightActiveLine","editor","ace","edit","session","getSession","aceWidestLine","renderer","chars","$getStringScreenWidth","characterWidth","$padding","lineLength","ceil","setValue","setTheme","readonly","setReadOnly","getValue","$cursorLayer","applyToPre","uploadElementId","readOneFile","reject","rdr","FileReader","onload","onerror","readAsText","setupFileHandler","hidden","className","alternativeName","preElements","getElementsByTagName","contains","hasAttribute","codeElements","parentNode","initAceInteractive","ace_inline_code_interactive_done","setTimeout","initAceHighlighting","ace_inline_code_highlighting_done"],"mappings":"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"}