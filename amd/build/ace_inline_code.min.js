/**
 * JavaScript for implementing both the ace_highlight_code and ace_interactive_code
 * functionality of the ace_line filter (q.v.)
 *
 * @module filter_ace_inline/highlight_code
 * @copyright  Richard Lobb, 2021, The University of Canterbury
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("filter_ace_inline/ace_inline_code",["jquery"],(function($){let uploadFiles={};function escapeHtml(text){const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,(function(m){return map[m]}))}function getUiParameters(pre,defaultParams){let uiParameters={},modifiedLang=!1;for(const attrName in defaultParams)if(defaultParams.hasOwnProperty(attrName)){let value="",dataName="",attr=pre.attributes.getNamedItem(attrName);if(attr?dataName=attrName:(dataName="data-"+attrName,attr=pre.attributes.getNamedItem(dataName)),attr)switch(value=attr.value,attrName){case"start-line-number":value="none"===value.toLowerCase()?null:parseInt(value);break;case"min-lines":case"max-lines":value=parseInt(value);break;case"hidden":value=!0;break;case"lang":modifiedLang=!0}else value=defaultParams[attrName];uiParameters[attrName]=value}return uiParameters.class.split(" ").forEach((attribute=>{attribute.startsWith("language")&&!1===modifiedLang&&(uiParameters.lang=attribute.replace("language-",""))})),uiParameters}async function getLangString(langStringName){return new Promise((resolve=>{require(["core/str"],(function(str){resolve(str.get_string(langStringName,"filter_ace_inline"))}))}))}function combinedOutput(response,maxLen){const limit=s=>s.length<=maxLen?s:s.substr(0,maxLen)+"... (truncated)";return response.cmpinfo+limit(response.output)+limit(response.stderr)}async function handleButtonClick(outputDisplayArea,code,uiParameters){cleanOutput(outputDisplayArea),outputDisplayArea.show();const mapFunc=uiParameters["code-mapper"];mapFunc&&(code=window[mapFunc](code)),code=uiParameters.prefix+code+uiParameters.suffix;const stdin=function(uiParameters){const taid=uiParameters["stdin-taid"],stdin=uiParameters.stdin;if(taid){return $("#"+taid).val()||null}return stdin||""}(uiParameters),files=await async function(uiParameters){let taids=uiParameters["file-taids"],map={};if(!$.isEmptyObject(taids)){try{taids=JSON.parse(taids)}catch(SyntaxError){return Promise.resolve("error")}for(const filename in taids)if(taids.hasOwnProperty(filename)){const id=taids[filename],value=$("#"+id).val();if(!value)return Promise.resolve("bad_id");map[filename]=value}}for(const name in uploadFiles)uploadFiles.hasOwnProperty(name)&&(map[name]=uploadFiles[name]);return Promise.resolve(JSON.stringify(map))}(uiParameters);if("markup"===uiParameters.lang||"html"===uiParameters.lang)return outputDisplayArea.attr("class","filter-ace-inline-output-html"),uiParameters["prev-lang"]=uiParameters.lang,uiParameters["html-output"]=!0,uiParameters.lang="python3",code="print('''"+code+"''')";if(null!==stdin&&"bad_id"!==files)return uiParameters["stdin-parse"]=stdin,uiParameters["file-parse"]=files,code;{outputDisplayArea.attr("class","filter-ace-inline-output-error");let text=await getLangString("error_user_params");return text="*** "+text+" ***\n"+await getLangString("error_element_unknown"),outputDisplayArea.find(".filter-ace-inline-output-text").html(escapeHtml(text)),null}}async function displayTextOutput(text,langString,outputDisplayArea){""!==langString&&(text="*** "+await getLangString(langString)+" ***\n"+text),outputDisplayArea.find(".filter-ace-inline-output-text").html(escapeHtml(text))}function cleanOutput(outputDisplayArea){outputDisplayArea.find(".filter-ace-inline-output-text").html(""),outputDisplayArea.next("div.filter-ace-inline-html").remove(),outputDisplayArea.attr("class","filter-ace-inline-output-display")}async function addUi(insertionPoint,getCode,uiParameters){const button=$("<button type='button' class='btn btn-secondary btn-ace-inline-execution' /button>"+uiParameters["button-name"]+"</button>"),buttonDiv=$("<div></div>"),outputDisplayArea=$("<div class='filter-ace-inline-output-display'/div>"),outputTextArea=$("<pre class='filter-ace-inline-output-text'></pre>");buttonDiv.append(button),$(insertionPoint).after(buttonDiv),buttonDiv.after(outputDisplayArea),outputDisplayArea.append(outputTextArea),outputDisplayArea.hide(),M.util.js_pending("core/ajax"),require(["core/ajax"],(function(ajax){button.on("click",(async function(){const code=await handleButtonClick(outputDisplayArea,getCode(),uiParameters);null!==code&&(!async function(ajax,outputDisplayArea,code,uiParameters){const htmlOutput=null!==uiParameters["html-output"],maxLen=uiParameters["max-output-length"];let text="",langString="";ajax.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{contextid:M.cfg.contextid,sourcecode:code,language:uiParameters.lang,stdin:uiParameters["stdin-parse"],files:uiParameters["file-parse"],params:uiParameters.params},done:function(responseJson){cleanOutput(outputDisplayArea);const response=JSON.parse(responseJson),error=function(response){const ERROR_RESPONSES=[[1,0,"error_access_denied"],[2,0,"error_unknown_language"],[3,0,"error_access_denied"],[4,0,"error_submission_limit_reached"],[5,0,"error_sandbox_server_overload"],[0,11,""],[0,12,""],[0,13,"error_timeout"],[0,15,""],[0,17,"error_memory_limit"],[0,21,"error_sandbox_server_overload"],[0,30,"error_excessive_output"]];for(const row of ERROR_RESPONSES)if(row[0]==response.error&&(0!=response.error||response.result==row[1]))return row[2];return"error_unknown_runtime"}(response);if(""===error)if(htmlOutput&&15===response.result){outputDisplayArea.attr("class","filter-ace-inline-output-html");const html=$("<div class='filter-ace-inline-html'>"+response.output+"</div>");outputDisplayArea.after(html)}else text+=combinedOutput(response,maxLen),15!==response.result&&outputDisplayArea.attr("class","filter-ace-inline-output-error");else{outputDisplayArea.attr("class","filter-ace-inline-output-error");let extra=0==response.error?combinedOutput(response,maxLen):"";"error_unknown_runtime"===error&&(extra+=response.error?"(Sandbox error code "+response.error+")":"(Run result: "+response.result+")"),langString+=error,text+=extra}displayTextOutput(text,langString,outputDisplayArea)},fail:function(error){cleanOutput(outputDisplayArea),outputDisplayArea.attr("class","filter-ace-inline-output-user"),langString+="error_user_params",text+=error.message,displayTextOutput(text,langString,outputDisplayArea)}}])}(ajax,outputDisplayArea,code,uiParameters),uiParameters.lang=uiParameters["prev-lang"]?uiParameters["prev-lang"]:uiParameters.lang)}))})),M.util.js_complete("core/ajax")}function applyAceHighlighting(root,config){applyAceAndBuildUi(root,!1,{class:"ace_highlight_code",lang:"python3","ace-lang":"","font-size":"11pt","start-line-number":null,"min-lines":1,"max-lines":50,readonly:!0,"dark-theme-mode":config.dark_theme_mode})}function applyAceInteractive(root,config){applyAceAndBuildUi(root,!0,{class:"ace_interactive_code",lang:"python3","ace-lang":"","font-size":"11pt",hidden:!1,"start-line-number":1,"button-name":config.button_label,readonly:null,stdin:"","stdin-taid":"","file-taids":{},"file-upload-id":null,prefix:"",suffix:"",params:'{"cputime": 5}',"code-mapper":null,"html-output":null,"min-lines":1,"max-lines":50,"max-output-length":3e4,"dark-theme-mode":config.dark_theme_mode})}async function setUpAce(pre,uiParameters,isInteractive){const aceModeMap={c:"c_cpp",cpp:"c_cpp",js:"javascript",nodejs:"javascript","c#":"cs",octave:"matlab","c++":"c_cpp",python2:"python",python3:"python",markup:"html"},darkMode=uiParameters["dark-theme-mode"];let theme=null;theme=2==darkMode||1==darkMode&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"ace/theme/tomorrow_night":"ace/theme/textmate",uiParameters.lang="python"===uiParameters.lang?"python3":uiParameters.lang;const showLineNumbers=!!uiParameters["start-line-number"];let aceLang=uiParameters["ace-lang"]?uiParameters["ace-lang"]:uiParameters.lang;aceLang=aceLang.toLowerCase(),aceLang in aceModeMap&&(aceLang=aceModeMap[aceLang]);const mode="ace/mode/"+aceLang,jqpre=$(pre),text=jqpre.text(),lines=text.split("\n"),numLines=lines.length,longestLine=function(lines){let longest="";for(const line of lines)line.length>longest.length&&(longest=line);return longest}(lines),editNode=$("<div></div>"),width=pre.scrollWidth,css={margin:"6px 0px 6px 0px","line-height":"1.3","min-width":width+"px"};editNode.css(css),jqpre.after(editNode);let aceConfig={newLineMode:"unix",mode:mode,minLines:Math.max(numLines,uiParameters["min-lines"]),maxLines:uiParameters["max-lines"],fontSize:uiParameters["font-size"],showLineNumbers:showLineNumbers,firstLineNumber:uiParameters["start-line-number"],showGutter:showLineNumbers,showPrintMargin:!1,autoScrollEditorIntoView:!0,highlightActiveLine:showLineNumbers};const editor=window.ace.edit(editNode.get(0),aceConfig),session=editor.getSession(),aceWidestLine=function(renderer,line){const chars=renderer.session.$getStringScreenWidth(line)[0];return Math.max(chars,2)*renderer.characterWidth+2*renderer.$padding+2+0}(editor.renderer,longestLine);if(aceWidestLine>width&&editNode.css({"min-width":Math.ceil(aceWidestLine)+"px"}),session.setValue(text),editor.setTheme(theme),null!==uiParameters.readonly&&editor.setReadOnly(!0),isInteractive){addUi(editNode,(()=>editor.getSession().getValue()),uiParameters)}else editor.renderer.$cursorLayer.element.style.display="none"}async function applyToPre(pre,isInteractive,uiParameters){const jqpre=$(pre);if(uiParameters["file-upload-id"]&&async function(uploadElementId){function readOneFile(file){return new Promise(((resolve,reject)=>{let rdr=new FileReader;rdr.onload=()=>{resolve(rdr.result)},rdr.onerror=reject,rdr.readAsText(file)}))}const element=$("#"+uploadElementId);element.prop("multiple","1"),element.change((async()=>{uploadFiles={};const files=element.prop("files");for(const file of files)uploadFiles[file.name]=await readOneFile(file)}))}(uiParameters["file-upload-id"]),uiParameters.hidden){if(isInteractive){addUi(pre,(()=>jqpre.text()),uiParameters)}}else setUpAce(pre,uiParameters,isInteractive);jqpre.hide()}async function applyAceAndBuildUi(root,isInteractive,defaultParams){const className=isInteractive?"ace-interactive-code":"ace-highlight-code",alternativeName=isInteractive?"data-ace-interactive-code":"data-ace-highlight-code",preElements=root.getElementsByTagName("pre");for(const pre of preElements)"none"!==pre.style.display&&(pre.classList.contains(className)||pre.hasAttribute(alternativeName))&&applyToPre(pre,isInteractive,getUiParameters(pre,defaultParams));const codeElements=root.getElementsByTagName("code");for(const code of codeElements)null!==code.parentNode&&"none"!==code.style.display&&(code.hasAttribute(alternativeName)||code.classList.contains(className))&&applyToPre(code.parentNode,isInteractive,getUiParameters(code,defaultParams))}return{initAceInteractive:async function(config){if(!window.ace_inline_code_interactive_done){for(window.ace_inline_code_interactive_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,100)));applyAceInteractive(document,config),window.applyAceInteractive=function(){applyAceInteractive(document,config)}}},initAceHighlighting:async function(config){if(!window.ace_inline_code_highlighting_done){for(window.ace_inline_code_highlighting_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,100)));applyAceHighlighting(document,config),window.applyAceHighlighting=function(){applyAceHighlighting(document,config)}}}}}));

//# sourceMappingURL=ace_inline_code.min.js.map