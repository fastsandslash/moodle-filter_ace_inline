/**
 * JavaScript for implementing both the ace_highlight_code and ace_interactive_code
 * functionality of the ace_line filter (q.v.)
 *
 * @module filter_ace_inline/highlight_code
 * @copyright  Richard Lobb, 2021, The University of Canterbury
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("filter_ace_inline/ace_inline_code",["jquery"],(function($){function escapeHtml(text){var map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,(function(m){return map[m]}))}function getUiParameters(pre,defaultParams){var attrName,attr,value,dataName,uiParameters={};for(attrName in defaultParams)(attr=pre.attributes.getNamedItem(attrName))?dataName=attrName:(dataName="data-"+attrName,attr=pre.attributes.getNamedItem(dataName)),attr?(value=attr.value,"start-line-number"===attrName&&(value="none"===value.toLowerCase()?null:parseInt(value))):value=defaultParams[attrName],uiParameters[attrName]=value;return uiParameters}function combinedOutput(response,maxLen){var limit=s=>s.length<=maxLen?s:s.substr(0,maxLen)+"... (truncated)";return response.cmpinfo+limit(response.output)+limit(response.stderr)}function handleButtonClick(ajax,outputDisplayArea,aceSession,uiParameters){var htmlOutput=null!==uiParameters["html-output"],maxLen=uiParameters["max-output-length"];outputDisplayArea.html(""),htmlOutput&&outputDisplayArea.hide(),outputDisplayArea.next("div.filter-ace-inline-html").remove();var code=aceSession.getValue(),mapFunc=uiParameters["code-mapper"];mapFunc&&(code=window[mapFunc](code)),code=uiParameters.prefix+code+uiParameters.suffix,ajax.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{contextid:M.cfg.contextid,sourcecode:code,language:uiParameters.lang,stdin:uiParameters.stdin,files:uiParameters.files,params:uiParameters.params},done:function(responseJson){var langStringName,textarea,additionalText,response=JSON.parse(responseJson),error=function(response){for(var ERROR_RESPONSES=[[1,0,"error_access_denied"],[2,0,"error_unknown_language"],[3,0,"error_access_denied"],[4,0,"error_submission_limit_reached"],[5,0,"error_sandbox_server_overload"],[0,11,""],[0,12,""],[0,13,"error_timeout"],[0,15,""],[0,17,"error_memory_limit"],[0,21,"error_sandbox_server_overload"],[0,30,"error_excessive_output"]],i=0;i<ERROR_RESPONSES.length;i++){var row=ERROR_RESPONSES[i];if(row[0]==response.error&&(0!=response.error||response.result==row[1]))return row[2]}return"error_unknown_runtime"}(response);if(""===error)if(htmlOutput&&15===response.result){outputDisplayArea.next("div.filter-ace-inline-html").remove();var html=$("<div class='filter-ace-inline-html 'style='background-color:#eff;padding:5px;'"+response.output+"</div>");outputDisplayArea.after(html)}else{var text=combinedOutput(response,maxLen);outputDisplayArea.show(),outputDisplayArea.html(escapeHtml(text))}else{var extra=0==response.error?combinedOutput(response,maxLen):"";"error_unknown_runtime"===error&&(extra+=response.error?"(Sandbox error code "+response.error+")":"(Run result: "+response.result+")"),langStringName=error,textarea=outputDisplayArea,additionalText=extra,require(["core/str"],(function(str){var promise=str.get_string(langStringName,"filter_ace_inline");$.when(promise).then((function(message){textarea.show(),textarea.html(escapeHtml("*** "+message+" ***\n"+additionalText))}))}))}},fail:function(error){alert(error.message)}}])}function addUi(editNode,aceSession,uiParameters){var button=$("<button type='button' class='btn btn-secondary' style='margin-bottom:6px;padding:2px 8px;'>"+uiParameters["button-name"]+"</button>"),buttonDiv=$("<div></div>"),outputDisplayArea=$("<pre style='width:100%;white-space:pre-wrap;background-color:#eff;border:1px gray;padding:5px;overflow-wrap:break-word;max-height:600px;overflow:auto;'></pre>");buttonDiv.append(button),editNode.after(buttonDiv),buttonDiv.after(outputDisplayArea),outputDisplayArea.hide(),M.util.js_pending("core/ajax"),require(["core/ajax"],(function(ajax){button.on("click",(function(){handleButtonClick(ajax,outputDisplayArea,aceSession,uiParameters)}))})),M.util.js_complete("core/ajax")}function applyAceHighlighting(ace,root){applyAceAndBuildUi(ace,root,!1,{lang:"python3","font-size":"11pt","start-line-number":null,readonly:!0})}function applyAceInteractive(ace,root,config){applyAceAndBuildUi(ace,root,!0,{lang:"python3","font-size":"11pt","start-line-number":1,"button-name":config.button_label,readonly:null,stdin:"",files:"",prefix:"",suffix:"",params:'{"cputime": 5}',"code-mapper":null,"html-output":null,"max-output-length":3e4})}function applyAceAndBuildUi(ace,root,isInteractive,defaultParams){var className=isInteractive?"ace-interactive-code":"ace-highlight-code",codeElements=root.getElementsByClassName(className),css={margin:"6px","line-height":"1.3"};for(let i=0;i<codeElements.length;i++){let pre=codeElements[i];if("PRE"===pre.nodeName&&"none"!==pre.style.display){let uiParameters=getUiParameters(pre,defaultParams),showLineNumbers=!!uiParameters["start-line-number"],jqpre=$(pre),text=jqpre.text(),numLines=text.split("\n").length,editNode=$("<div></div>");css["min-width"]=pre.scrollWidth,editNode.css(css),jqpre.after(editNode);let aceConfig={newLineMode:"unix",mode:"ace/mode/python",minLines:numLines,maxLines:50,fontSize:uiParameters["font-size"],showLineNumbers:showLineNumbers,firstLineNumber:uiParameters["start-line-number"],showGutter:showLineNumbers,showPrintMargin:!1,autoScrollEditorIntoView:!0,highlightActiveLine:showLineNumbers},editor=ace.edit(editNode.get(0),aceConfig),session=editor.getSession();session.setValue(text),null!==uiParameters.readonly&&editor.setReadOnly(!0),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?editor.setTheme("ace/theme/tomorrow_night"):editor.setTheme("ace/theme/textmate"),isInteractive?addUi(editNode,session,uiParameters):editor.renderer.$cursorLayer.element.style.display="none",jqpre.hide()}}}return{initAceInteractive:async function(config){if(!window.ace_inline_code_interactive_done){for(window.ace_inline_code_interactive_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,1e3)));applyAceInteractive(window.ace,document,config),window.applyAceInteractive=function(){applyAceInteractive(window.ace,document,config)}}},initAceHighlighting:async function(){if(!window.ace_inline_code_highlighting_done){for(window.ace_inline_code_highlighting_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,1e3)));applyAceHighlighting(window.ace,document),window.applyAceHighlighting=function(){applyAceHighlighting(window.ace,document)}}}}}));

//# sourceMappingURL=ace_inline_code.min.js.map