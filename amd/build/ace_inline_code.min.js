/**
 * JavaScript for implementing both the ace_highlight_code and ace_interactive_code
 * functionality of the ace_line filter (q.v.)
 *
 * @module filter_ace_inline/highlight_code
 * @copyright  Richard Lobb, 2021, The University of Canterbury
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("filter_ace_inline/ace_inline_code",["jquery"],(function($){let uploadFiles={};function escapeHtml(text){const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,(function(m){return map[m]}))}function getUiParameters(pre,defaultParams){let uiParameters={};for(const attrName in defaultParams)if(defaultParams.hasOwnProperty(attrName)){let value="",dataName="",attr=pre.attributes.getNamedItem(attrName);attr?dataName=attrName:(dataName="data-"+attrName,attr=pre.attributes.getNamedItem(dataName)),attr?(value=attr.value,"start-line-number"===attrName?value="none"===value.toLowerCase()?null:parseInt(value):"min-lines"===attrName||"max-lines"===attrName?value=parseInt(value):"hidden"===attrName&&(value=!0)):value=defaultParams[attrName],uiParameters[attrName]=value}return uiParameters}function setLangString(langStringName,additionalText,outputTextArea){require(["core/str"],(function(str){const promise=str.get_string(langStringName,"filter_ace_inline");$.when(promise).done((function(message){outputTextArea.html(escapeHtml("*** "+message+" ***\n"+additionalText))}))}))}function combinedOutput(response,maxLen){const limit=s=>s.length<=maxLen?s:s.substr(0,maxLen)+"... (truncated)";return response.cmpinfo+limit(response.output)+limit(response.stderr)}function getStdin(uiParameters){const taid=uiParameters["stdin-taid"],stdin=uiParameters.stdin;if(taid){let output=$("#"+taid).val();return output||null}return stdin||""}async function getFiles(uiParameters){let taids=uiParameters["file-taids"],map={};if(!$.isEmptyObject(taids)){try{taids=JSON.parse(taids)}catch(SyntaxError){return Promise.resolve("error")}for(const filename in taids)if(taids.hasOwnProperty(filename)){const id=taids[filename],value=$("#"+id).val();map[filename]=value}}for(const name in uploadFiles)uploadFiles.hasOwnProperty(name)&&(map[name]=uploadFiles[name]);return Promise.resolve(JSON.stringify(map))}function createTextNode(){const outputTextArea=$("<pre class='output-text-area'</pre>");return outputTextArea.css({overflowWrap:"break-word",whiteSpace:"pre-wrap",width:"100%",overflow:"auto",maxHeight:"600px",marginTop:"0px",marginBottom:"0px"}),outputTextArea}function handleOutput(text,outputDisplayArea,outputTextArea){outputTextArea.html(escapeHtml(text)),outputDisplayArea.append(outputTextArea)}function cleanOutput(outputDisplayArea){outputDisplayArea.html(""),outputDisplayArea.next("div.filter-ace-inline-html").remove(),outputDisplayArea.css({backgroundColor:"#eff"})}async function addUi(insertionPoint,getCode,uiParameters){const button=$("<button type='button' class='btn btn-secondary' /button>"+uiParameters["button-name"]+"</button>");button.css({marginBottom:"6px",padding:"2px 8px"});const buttonDiv=$("<div></div>"),outputDisplayArea=$("<div class='output-display-area' /div>");outputDisplayArea.css({backgroundColor:"#eff",padding:"5px 10px 5px",verticalAlign:"middle"}),buttonDiv.append(button),$(insertionPoint).after(buttonDiv),buttonDiv.after(outputDisplayArea),outputDisplayArea.hide(),M.util.js_pending("core/ajax"),require(["core/ajax"],(function(ajax){button.on("click",(function(){const code=function(outputDisplayArea,code,uiParameters){cleanOutput(outputDisplayArea),outputDisplayArea.show();const mapFunc=uiParameters["code-mapper"];if(mapFunc&&(code=window[mapFunc](code)),code=uiParameters.prefix+code+uiParameters.suffix,null!==getStdin(uiParameters))return code;{outputDisplayArea.css({border:"1px solid red",backgroundColor:"#faa"});const textArea=createTextNode();return setLangString("error_user_params","Id not found for element",textArea),handleOutput("",outputDisplayArea,textArea),null}}(outputDisplayArea,getCode(),uiParameters);null!==code&&async function(ajax,outputDisplayArea,code,uiParameters){const htmlOutput=null!==uiParameters["html-output"],maxLen=uiParameters["max-output-length"],outputTextArea=createTextNode();ajax.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{contextid:M.cfg.contextid,sourcecode:code,language:uiParameters.lang,stdin:getStdin(uiParameters),files:await getFiles(uiParameters),params:uiParameters.params},done:function(responseJson){cleanOutput(outputDisplayArea);const response=JSON.parse(responseJson),error=function(response){const ERROR_RESPONSES=[[1,0,"error_access_denied"],[2,0,"error_unknown_language"],[3,0,"error_access_denied"],[4,0,"error_submission_limit_reached"],[5,0,"error_sandbox_server_overload"],[0,11,""],[0,12,""],[0,13,"error_timeout"],[0,15,""],[0,17,"error_memory_limit"],[0,21,"error_sandbox_server_overload"],[0,30,"error_excessive_output"]];for(const row of ERROR_RESPONSES)if(row[0]==response.error&&(0!=response.error||response.result==row[1]))return row[2];return"error_unknown_runtime"}(response);if(""===error)if(htmlOutput&&15===response.result){const html=$("<div class='filter-ace-inline-html 'style='background-color:#eff;padding:5px;'>"+response.output+"</div>");outputDisplayArea.after(html)}else{const text=combinedOutput(response,maxLen);15!==response.result&&outputDisplayArea.css({backgroundColor:"#faa"}),handleOutput(text,outputDisplayArea,outputTextArea)}else{let extra=0==response.error?combinedOutput(response,maxLen):"";"error_unknown_runtime"===error&&(extra+=response.error?"(Sandbox error code "+response.error+")":"(Run result: "+response.result+")"),outputDisplayArea.css({backgroundColor:"#faa"}),handleOutput("",outputDisplayArea,outputTextArea),setLangString(error,extra,outputTextArea)}},fail:function(error){cleanOutput(outputDisplayArea),outputDisplayArea.css({border:"1px solid red",backgroundColor:"#faa"}),handleOutput("",outputDisplayArea,outputTextArea),setLangString("error_user_params",error.message,outputTextArea)}}])}(ajax,outputDisplayArea,code,uiParameters)}))})),M.util.js_complete("core/ajax")}function applyAceHighlighting(root,config){applyAceAndBuildUi(root,!1,{lang:"python3","ace-lang":"","font-size":"11pt","start-line-number":null,"min-lines":1,"max-lines":50,readonly:!0,"dark-theme-mode":config.dark_theme_mode})}function applyAceInteractive(root,config){applyAceAndBuildUi(root,!0,{lang:"python3","ace-lang":"","font-size":"11pt",hidden:!1,"start-line-number":1,"button-name":config.button_label,readonly:null,stdin:"","stdin-taid":"","file-taids":{},"file-upload-id":null,prefix:"",suffix:"",params:'{"cputime": 5}',"code-mapper":null,"html-output":null,"min-lines":1,"max-lines":50,"max-output-length":3e4,"dark-theme-mode":config.dark_theme_mode})}async function setUpAce(pre,uiParameters,isInteractive){const aceModeMap={c:"c_cpp",cpp:"c_cpp",js:"javascript",nodejs:"javascript","c#":"cs",octave:"matlab","c++":"c_cpp",python2:"python",python3:"python"},darkMode=uiParameters["dark-theme-mode"];let theme=null;theme=2==darkMode||1==darkMode&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"ace/theme/tomorrow_night":"ace/theme/textmate";const showLineNumbers=!!uiParameters["start-line-number"];let aceLang=uiParameters["ace-lang"]?uiParameters["ace-lang"]:uiParameters.lang;aceLang=aceLang.toLowerCase(),aceLang in aceModeMap&&(aceLang=aceModeMap[aceLang]);const mode="ace/mode/"+aceLang,jqpre=$(pre),text=jqpre.text(),lines=text.split("\n"),numLines=lines.length,longestLine=function(lines){let longest="";for(const line of lines)line.length>longest.length&&(longest=line);return longest}(lines),editNode=$("<div></div>"),width=pre.scrollWidth,css={margin:"6px 0px 6px 0px","line-height":"1.3","min-width":width+"px"};editNode.css(css),jqpre.after(editNode);var aceConfig={newLineMode:"unix",mode:mode,minLines:Math.max(numLines,uiParameters["min-lines"]),maxLines:uiParameters["max-lines"],fontSize:uiParameters["font-size"],showLineNumbers:showLineNumbers,firstLineNumber:uiParameters["start-line-number"],showGutter:showLineNumbers,showPrintMargin:!1,autoScrollEditorIntoView:!0,highlightActiveLine:showLineNumbers};const editor=window.ace.edit(editNode.get(0),aceConfig),session=editor.getSession(),aceWidestLine=function(renderer,line){const chars=renderer.session.$getStringScreenWidth(line)[0];return Math.max(chars,2)*renderer.characterWidth+2*renderer.$padding+2+0}(editor.renderer,longestLine);if(aceWidestLine>width&&editNode.css({"min-width":Math.ceil(aceWidestLine)+"px"}),session.setValue(text),editor.setTheme(theme),null!==uiParameters.readonly&&editor.setReadOnly(!0),isInteractive){addUi(editNode,(()=>editor.getSession().getValue()),uiParameters)}else editor.renderer.$cursorLayer.element.style.display="none"}async function applyToPre(pre,isInteractive,uiParameters){const jqpre=$(pre);if(uiParameters["file-upload-id"]&&async function(uploadElementId){function readOneFile(file){return new Promise(((resolve,reject)=>{var rdr=new FileReader;rdr.onload=()=>{resolve(rdr.result)},rdr.onerror=reject,rdr.readAsText(file)}))}const element=$("#"+uploadElementId);element.prop("multiple","1"),element.change((async()=>{uploadFiles={};const files=element.prop("files");for(const file of files)uploadFiles[file.name]=await readOneFile(file)}))}(uiParameters["file-upload-id"]),uiParameters.hidden){if(isInteractive){addUi(pre,(()=>jqpre.text()),uiParameters)}}else setUpAce(pre,uiParameters,isInteractive);jqpre.hide()}async function applyAceAndBuildUi(root,isInteractive,defaultParams){const className=isInteractive?"ace-interactive-code":"ace-highlight-code",codeElements=root.getElementsByClassName(className);for(const pre of codeElements){const uiParameters=getUiParameters(pre,defaultParams);"PRE"===pre.nodeName&&"none"!==pre.style.display&&applyToPre(pre,isInteractive,uiParameters)}}return{initAceInteractive:async function(config){if(!window.ace_inline_code_interactive_done){for(window.ace_inline_code_interactive_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,1e3)));applyAceInteractive(document,config),window.applyAceInteractive=function(){applyAceInteractive(document,config)}}},initAceHighlighting:async function(config){if(!window.ace_inline_code_highlighting_done){for(window.ace_inline_code_highlighting_done=!0;!window.ace;)await new Promise((resolve=>setTimeout(resolve,1e3)));applyAceHighlighting(document,config),window.applyAceHighlighting=function(){applyAceHighlighting(document,config)}}}}}));

//# sourceMappingURL=ace_inline_code.min.js.map